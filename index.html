<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n Estrat√©gica Lechera</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active {
            border-bottom: 2px solid #10b981;
            color: #059669;
            background-color: #ecfdf5;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .tab-inactive:hover {
            color: #374151;
            background-color: #f9fafb;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .scroll-container {
            max-height: 24rem;
            overflow-y: auto;
        }
        .pulse-save {
            animation: pulse 0.5s ease-in-out;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="bg-green-600 text-white p-6 shadow-lg">
        <h1 class="text-3xl font-bold">Sistema de Gesti√≥n Estrat√©gica Lechera</h1>
        <p class="text-green-100 mt-2">San Pedro de los Milagros, Antioquia - Colombia</p>
        
        <!-- Barra de progreso -->
        <div class="mt-4">
            <div class="flex justify-between text-sm mb-2">
                <span>Progreso del registro</span>
                <span id="progress-text">0/6 secciones completadas</span>
            </div>
            <div class="w-full bg-green-400 rounded-full h-2">
                <div id="progress-bar" class="bg-white h-2 rounded-full progress-bar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Navegaci√≥n por pesta√±as -->
        <div class="bg-white rounded-lg shadow-sm mb-6 overflow-x-auto">
            <div class="flex border-b" id="tab-navigation">
                <!-- Las pesta√±as se generar√°n din√°micamente -->
            </div>
        </div>

        <!-- Contenido de las pesta√±as -->
        <div id="tab-content">
            <!-- El contenido se generar√° din√°micamente -->
        </div>

        <!-- Navegaci√≥n inferior -->
        <div class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t p-4" id="bottom-navigation">
            <div class="container mx-auto flex justify-between items-center">
                <button
                    id="prev-button"
                    onclick="navigateTab(-1)"
                    class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    ‚Üê Anterior
                </button>
                
                <div class="flex items-center space-x-4">
                    <span id="save-status" class="text-sm text-gray-600"></span>
                    <button
                        id="save-button"
                        onclick="saveCurrentData()"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                    >
                        üíæ Guardar
                    </button>
                </div>
                
                <button
                    id="next-button"
                    onclick="navigateTab(1)"
                    class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                >
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Espacio para la navegaci√≥n fija -->
        <div class="h-20"></div>
    </div>

    <script>
        // Datos de la aplicaci√≥n
        let appData = {
            // Informaci√≥n de la Finca
            nombre_finca: '',
            propietario: '',
            telefono: '',
            email: '',
            ubicacion: '',
            
            // Datos Generales
            vacas: 114,
            area: 125,
            volumen: 902300,
            precio_leche: 2400,
            empleados: 7,
            sistema_produccion: 'Pastoreo',
            novillas: 101,
            region: 'San Pedro de los Milagros',
            valor_hectarea: 45000000,
            ensilaje: 42,
            
            // Ingresos
            venta_leche: 0, // Se calcular√° autom√°ticamente
            venta_animales: 156000000,
            venta_estiercol: 12000000,
            otros_ingresos: 0,
            cambio_stock_animales: 85000000,
            cambio_stock_alimentos: 25000000,
            
            // Gastos B√°sicos
            mantenimiento_maquinas: 45000000,
            mantenimiento_instalaciones: 65000000,
            alquiler_maquinas: 55000000,
            energia: 72000000,
            alimentos_comprados: 865000000,
            correctivos_fertilizantes: 35000000,
            productos_quimicos: 25000000,
            semillas: 15000000,
            reproduccion: 35000000,
            salud: 55000000,
            consumibles: 45000000,
            bst: 48000000,
            impuestos: 42000000,
            
            // Gastos Adicionales
            mano_obra_fija: 168000000,
            mano_obra_temporal: 35000000,
            administracion: 96000000,
            intereses_prestamos: 45000000,
            depreciacion_maquinaria: 35000000,
            depreciacion_instalaciones: 25000000,
            
            // Inversiones
            inversiones_instalaciones: 850000000,
            inversiones_maquinaria: 650000000,
            inversiones_animales: 0, // Se calcular√° autom√°ticamente
            inversiones_tierra: 0 // Se calcular√° autom√°ticamente
        };

        let activeTab = 'datos_generales';
        let aiAnalysis = null;
        let isAnalyzing = false;
        let savedSections = new Set();

        // Definici√≥n de pesta√±as con orden
        const tabs = [
            { id: 'datos_generales', label: 'Datos Generales', icon: 'calculator', order: 0 },
            { id: 'ingresos', label: 'Ingresos', icon: 'trending-up', order: 1 },
            { id: 'gastos', label: 'Gastos', icon: 'dollar-sign', order: 2 },
            { id: 'inversiones', label: 'Inversiones', icon: 'pie-chart', order: 3 },
            { id: 'resultados', label: 'Resultados', icon: 'bar-chart-3', order: 4 },
            { id: 'analisis', label: 'An√°lisis IA', icon: 'brain', order: 5 }
        ];

        // Iconos usando Lucide
        const icons = {
            Calculator: 'calculator',
            TrendingUp: 'trending-up',
            DollarSign: 'dollar-sign',
            PieChart: 'pie-chart',
            BarChart3: 'bar-chart-3',
            Brain: 'brain',
            AlertCircle: 'alert-circle',
            CheckCircle: 'check-circle',
            Info: 'info',
            Building: 'building',
            Download: 'download',
            Droplets: 'droplets'
        };

        // Funciones de formateo
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('es-CO').format(value);
        }

        // Funci√≥n para calcular valores autom√°ticamente
        function calculateAutomaticValues() {
            // Calcular venta de leche autom√°ticamente
            appData.venta_leche = appData.volumen * appData.precio_leche;
            
            // Calcular inversi√≥n en animales (vacas + novillas)
            const precio_promedio_vaca = 3500000; // Precio promedio por vaca
            const precio_promedio_novilla = 2800000; // Precio promedio por novilla
            appData.inversiones_animales = (appData.vacas * precio_promedio_vaca) + (appData.novillas * precio_promedio_novilla);
            
            // Calcular inversi√≥n en tierra
            appData.inversiones_tierra = appData.area * appData.valor_hectarea;
        }

        // C√°lculos principales con valores actualizados
        function getCalculations() {
            // Calcular valores autom√°ticos primero
            calculateAutomaticValues();
            
            const leche_eq_kg = appData.volumen * 1.18;
            const total_ingresos = appData.venta_leche + appData.venta_animales + appData.venta_estiercol + 
                                 appData.otros_ingresos + appData.cambio_stock_animales + appData.cambio_stock_alimentos;
            
            // C√°lculo de Leche Equivalente (todos los ingresos convertidos a litros de leche)
            const leche_equivalente_total = appData.precio_leche > 0 ? total_ingresos / appData.precio_leche : 0;
            const leche_equivalente_por_vaca = appData.vacas > 0 ? leche_equivalente_total / appData.vacas : 0;
            const leche_equivalente_por_hectarea = appData.area > 0 ? leche_equivalente_total / appData.area : 0;
            
            const gastos_basicos = appData.mantenimiento_maquinas + appData.mantenimiento_instalaciones + 
                                 appData.alquiler_maquinas + appData.energia + appData.alimentos_comprados + 
                                 appData.correctivos_fertilizantes + appData.productos_quimicos + appData.semillas + 
                                 appData.reproduccion + appData.salud + appData.consumibles + appData.bst + appData.impuestos;
            
            const gastos_adicionales = appData.mano_obra_fija + appData.mano_obra_temporal + appData.administracion + 
                                     appData.intereses_prestamos + appData.depreciacion_maquinaria + 
                                     appData.depreciacion_instalaciones;
            
            const total_gastos = gastos_basicos + gastos_adicionales;
            
            const total_inversiones = appData.inversiones_instalaciones + appData.inversiones_maquinaria + 
                                    appData.inversiones_animales + appData.inversiones_tierra;
            
            const lucro = total_ingresos - total_gastos;
            const retorno_capital = total_inversiones > 0 ? (lucro / total_inversiones) * 100 : 0;
            const litros_por_empleado = appData.empleados > 0 ? appData.volumen / appData.empleados : 0;
            const costo_produccion_litro = appData.volumen > 0 ? total_gastos / appData.volumen : 0;
            const margen_por_litro = appData.volumen > 0 ? lucro / appData.volumen : 0;
            const productividad_por_vaca = appData.vacas > 0 ? appData.volumen / appData.vacas : 0;
            const productividad_por_hectarea = appData.area > 0 ? appData.volumen / appData.area : 0;

            return {
                leche_eq_kg,
                leche_equivalente_total,
                leche_equivalente_por_vaca,
                leche_equivalente_por_hectarea,
                total_ingresos,
                gastos_basicos,
                gastos_adicionales,
                total_gastos,
                total_inversiones,
                lucro,
                retorno_capital,
                litros_por_empleado,
                costo_produccion_litro,
                margen_por_litro,
                productividad_por_vaca,
                productividad_por_hectarea
            };
        }

        // Navegaci√≥n entre pesta√±as
        function navigateTab(direction) {
            const currentTabObj = tabs.find(tab => tab.id === activeTab);
            const currentOrder = currentTabObj.order;
            const newOrder = currentOrder + direction;
            
            if (newOrder >= 0 && newOrder < tabs.length) {
                const newTab = tabs.find(tab => tab.order === newOrder);
                if (newTab) {
                    // Guardar datos antes de cambiar
                    saveCurrentData();
                    setActiveTab(newTab.id);
                }
            }
        }

        // Guardar datos de la secci√≥n actual
        function saveCurrentData() {
            savedSections.add(activeTab);
            updateProgress();
            
            // Mostrar feedback visual
            const saveButton = document.getElementById('save-button');
            const saveStatus = document.getElementById('save-status');
            
            saveButton.classList.add('pulse-save');
            saveStatus.textContent = '‚úÖ Datos guardados';
            saveStatus.style.color = '#10b981';
            
            setTimeout(() => {
                saveButton.classList.remove('pulse-save');
                saveStatus.textContent = '';
            }, 2000);
            
            // Recalcular valores autom√°ticamente
            calculateAutomaticValues();
            renderTabContent();
        }

        // Actualizar barra de progreso
        function updateProgress() {
            const progress = (savedSections.size / tabs.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${savedSections.size}/${tabs.length} secciones completadas`;
        }

        // Actualizar botones de navegaci√≥n
        function updateNavigationButtons() {
            const currentTabObj = tabs.find(tab => tab.id === activeTab);
            const currentOrder = currentTabObj.order;
            
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            
            prevButton.disabled = currentOrder === 0;
            
            if (currentOrder === tabs.length - 1) {
                nextButton.textContent = 'Finalizar';
                nextButton.onclick = () => {
                    saveCurrentData();
                    alert('¬°Registro completado! Todos los datos han sido guardados.');
                };
            } else {
                nextButton.textContent = 'Siguiente ‚Üí';
                nextButton.onclick = () => navigateTab(1);
            }
        }

        // Funci√≥n para crear iconos
        function createIcon(iconName, size = 16, className = '') {
            return `<i data-lucide="${iconName}" class="w-${size/4} h-${size/4} ${className}"></i>`;
        }

        // Componente InputField mejorado
        function createInputField(label, value, field, type = 'number', min = 0, tooltip = '', readonly = false) {
            const tooltipHtml = tooltip ? `<span class="ml-1 text-gray-400" title="${tooltip}">${createIcon('info', 14, 'inline')}</span>` : '';
            const readonlyAttr = readonly ? 'readonly' : '';
            const readonlyClass = readonly ? 'bg-gray-100 cursor-not-allowed' : '';
            
            return `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        ${label}
                        ${tooltipHtml}
                        ${readonly ? '<span class="text-xs text-blue-600">(Calculado autom√°ticamente)</span>' : ''}
                    </label>
                    <input
                        type="${type}"
                        value="${value}"
                        ${type === 'number' ? `min="${min}"` : ''}
                        ${readonlyAttr}
                        onchange="updateData('${field}', ${type === 'number' ? 'parseFloat(this.value) || 0' : 'this.value'})"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent ${readonlyClass}"
                    />
                </div>
            `;
        }

        // Componente SimpleChart
        function createSimpleChart(title, data) {
            const maxValue = Math.max(...data.map(d => d.value));
            const chartItems = data.map((item, index) => {
                const percentage = maxValue > 0 ? (item.value / maxValue) * 100 : 0;
                const formattedValue = typeof item.value === 'number' ? 
                    (item.value >= 1000000 ? formatCurrency(item.value) : formatNumber(item.value)) : 
                    item.value;
                
                return `
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">${item.label}</span>
                        <div class="flex items-center space-x-2">
                            <div class="w-32 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full progress-bar" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm font-medium w-32 text-right">${formattedValue}</span>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">${title}</h4>
                    <div class="space-y-2">
                        ${chartItems}
                    </div>
                </div>
            `;
        }

        // Componente KPICard
        function createKPICard(title, value, iconName, color = 'green', change = null, unit = '') {
            const changeHtml = change ? `
                <p class="text-sm ${change > 0 ? 'text-green-600' : 'text-red-600'}">
                    ${change > 0 ? '+' : ''}${change}% vs anterior
                </p>
            ` : '';

            const formattedValue = typeof value === 'number' ? 
                (value >= 1000000 ? formatCurrency(value) : formatNumber(value)) : 
                value;

            return `
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">${title}</p>
                            <p class="text-2xl font-bold text-${color}-600">
                                ${formattedValue} ${unit}
                            </p>
                            ${changeHtml}
                        </div>
                        ${createIcon(iconName, 32, `text-${color}-600`)}
                    </div>
                </div>
            `;
        }

        // Funci√≥n para exportar a PDF
        function exportToPDF() {
            const calculations = getCalculations();
            
            // Crear contenido HTML para el PDF
            const pdfContent = `
                <div style="font-family: Arial, sans-serif; margin: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #10b981; padding-bottom: 20px;">
                        <h1 style="color: #059669; margin: 0;">Reporte de Gesti√≥n Lechera</h1>
                        <h2 style="color: #374151; margin: 10px 0;">${appData.nombre_finca || 'Finca Lechera'}</h2>
                        <p style="color: #6b7280; margin: 5px 0;">Propietario: ${appData.propietario || 'No especificado'}</p>
                        <p style="color: #6b7280; margin: 5px 0;">Ubicaci√≥n: ${appData.ubicacion || appData.region}</p>
                        <p style="color: #6b7280; margin: 5px 0;">Fecha del reporte: ${new Date().toLocaleDateString('es-CO')}</p>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #059669; border-bottom: 1px solid #d1d5db; padding-bottom: 5px;">Datos Productivos</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Vacas en Producci√≥n:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(appData.vacas)} cabezas</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>√Årea de la Finca:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(appData.area)} hect√°reas</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Producci√≥n Anual:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(appData.volumen)} litros</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Precio de Leche:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(appData.precio_leche)} por litro</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>N√∫mero de Empleados:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(appData.empleados)} personas</td></tr>
                        </table>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #059669; border-bottom: 1px solid #d1d5db; padding-bottom: 5px;">Indicadores de Productividad</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Productividad por Vaca:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(calculations.productividad_por_vaca.toFixed(0))} L/vaca/a√±o</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Productividad por Hect√°rea:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(calculations.productividad_por_hectarea.toFixed(0))} L/ha/a√±o</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Leche Equivalente Total:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(calculations.leche_equivalente_total.toFixed(0))} litros</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Leche Equivalente por Vaca:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(calculations.leche_equivalente_por_vaca.toFixed(0))} L/vaca</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Leche Equivalente por Hect√°rea:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatNumber(calculations.leche_equivalente_por_hectarea.toFixed(0))} L/ha</td></tr>
                        </table>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #059669; border-bottom: 1px solid #d1d5db; padding-bottom: 5px;">Resultados Financieros</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Ingresos Totales:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb; color: #059669;">${formatCurrency(calculations.total_ingresos)}</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Gastos Totales:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb; color: #dc2626;">${formatCurrency(calculations.total_gastos)}</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Lucro:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb; color: ${calculations.lucro > 0 ? '#059669' : '#dc2626'}; font-weight: bold;">${formatCurrency(calculations.lucro)}</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Retorno sobre Capital:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb; color: ${calculations.retorno_capital > 0 ? '#059669' : '#dc2626'};">${calculations.retorno_capital.toFixed(2)}%</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Costo por Litro:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(calculations.costo_produccion_litro)}</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Margen por Litro:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb; color: ${calculations.margen_por_litro > 0 ? '#059669' : '#dc2626'};">${formatCurrency(calculations.margen_por_litro)}</td></tr>
                        </table>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #059669; border-bottom: 1px solid #d1d5db; padding-bottom: 5px;">Inversiones</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Inversi√≥n Total:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(calculations.total_inversiones)}</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Inversi√≥n por Vaca:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(appData.vacas > 0 ? calculations.total_inversiones / appData.vacas : 0)}</td></tr>
                            <tr><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;"><strong>Inversi√≥n por Hect√°rea:</strong></td><td style="padding: 5px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(appData.area > 0 ? calculations.total_inversiones / appData.area : 0)}</td></tr>
                        </table>
                    </div>

                    ${aiAnalysis ? `
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #059669; border-bottom: 1px solid #d1d5db; padding-bottom: 5px;">An√°lisis Inteligente</h3>
                        <div style="margin-top: 15px;">
                            <h4 style="color: #374151; margin-bottom: 10px;">Resumen Ejecutivo:</h4>
                            <p style="margin-bottom: 15px; line-height: 1.5;">${aiAnalysis.resumen_ejecutivo}</p>
                            
                            ${aiAnalysis.fortalezas && aiAnalysis.fortalezas.length > 0 ? `
                            <h4 style="color: #059669; margin-bottom: 10px;">Fortalezas:</h4>
                            <ul style="margin-bottom: 15px; line-height: 1.5;">
                                ${aiAnalysis.fortalezas.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                            ` : ''}
                            
                            ${aiAnalysis.recomendaciones && aiAnalysis.recomendaciones.length > 0 ? `
                            <h4 style="color: #2563eb; margin-bottom: 10px;">Recomendaciones:</h4>
                            <ul style="margin-bottom: 15px; line-height: 1.5;">
                                ${aiAnalysis.recomendaciones.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <div style="margin-top: 30px; text-align: center; border-top: 1px solid #d1d5db; padding-top: 20px; color: #6b7280; font-size: 12px;">
                        <p>Reporte generado por Sistema de Gesti√≥n Estrat√©gica Lechera</p>
                        <p>San Pedro de los Milagros, Antioquia - Colombia</p>
                        <p>Contacto: ${appData.telefono || ''} | ${appData.email || ''}</p>
                    </div>
                </div>
            `;

            // Crear ventana para imprimir
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Reporte de Gesti√≥n Lechera - ${appData.nombre_finca || 'Finca'}</title>
                    <meta charset="UTF-8">
                    <style>
                        @media print {
                            body { margin: 0; }
                            @page { margin: 1cm; }
                        }
                        body { font-family: Arial, sans-serif; }
                    </style>
                </head>
                <body>
                    ${pdfContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Esperar a que se cargue y abrir di√°logo de impresi√≥n
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // Funci√≥n para an√°lisis con IA
        async function analyzeWithAI() {
            if (!window.claude || !window.claude.complete) {
                alert('Funci√≥n de an√°lisis IA no disponible');
                return;
            }

            isAnalyzing = true;
            updateAnalysisButton();
            
            const calculations = getCalculations();
            
            const prompt = `
            Analiza estos datos de una finca lechera en San Pedro de los Milagros, Antioquia:
            
            INFORMACI√ìN DE LA FINCA:
            - Nombre: ${appData.nombre_finca || 'No especificado'}
            - Propietario: ${appData.propietario || 'No especificado'}
            - Ubicaci√≥n: ${appData.ubicacion || appData.region}
            
            DATOS PRODUCTIVOS:
            - Vacas en producci√≥n: ${appData.vacas}
            - √Årea: ${appData.area} hect√°reas
            - Producci√≥n anual: ${formatNumber(appData.volumen)} litros
            - Precio leche: ${formatCurrency(appData.precio_leche)}/litro
            - Empleados: ${appData.empleados}
            - Productividad: ${formatNumber(calculations.productividad_por_vaca)} L/vaca/a√±o
            - Productividad por hect√°rea: ${formatNumber(calculations.productividad_por_hectarea)} L/ha
            
            LECHE EQUIVALENTE:
            - Leche equivalente total: ${formatNumber(calculations.leche_equivalente_total)} litros
            - Leche equivalente por vaca: ${formatNumber(calculations.leche_equivalente_por_vaca)} L/vaca
            - Leche equivalente por hect√°rea: ${formatNumber(calculations.leche_equivalente_por_hectarea)} L/ha
            
            RESULTADOS FINANCIEROS:
            - Ingresos totales: ${formatCurrency(calculations.total_ingresos)}
            - Gastos totales: ${formatCurrency(calculations.total_gastos)}
            - Lucro: ${formatCurrency(calculations.lucro)}
            - Retorno sobre capital: ${calculations.retorno_capital.toFixed(2)}%
            - Costo producci√≥n/litro: ${formatCurrency(calculations.costo_produccion_litro)}
            - Margen por litro: ${formatCurrency(calculations.margen_por_litro)}
            
            INVERSIONES:
            - Inversi√≥n total: ${formatCurrency(calculations.total_inversiones)}
            - Inversi√≥n por vaca: ${formatCurrency(calculations.total_inversiones / appData.vacas)}
            - Inversi√≥n por hect√°rea: ${formatCurrency(calculations.total_inversiones / appData.area)}
            
            Proporciona un an√°lisis detallado en formato JSON con:
            {
              "resumen_ejecutivo": "An√°lisis general de la situaci√≥n",
              "fortalezas": ["lista de fortalezas"],
              "areas_mejora": ["lista de √°reas de mejora"],
              "recomendaciones": ["lista de recomendaciones espec√≠ficas"],
              "indicadores_clave": {
                "productividad": "an√°lisis de productividad",
                "rentabilidad": "an√°lisis de rentabilidad",
                "eficiencia": "an√°lisis de eficiencia",
                "leche_equivalente": "an√°lisis del indicador de leche equivalente"
              },
              "alertas": ["alertas importantes si las hay"]
            }
            
            Responde SOLO con el JSON v√°lido, sin texto adicional.
            `;

            try {
                const response = await window.claude.complete(prompt);
                aiAnalysis = JSON.parse(response);
            } catch (error) {
                console.error('Error en an√°lisis IA:', error);
                aiAnalysis = {
                    resumen_ejecutivo: "Error al generar an√°lisis. Por favor, intenta nuevamente.",
                    fortalezas: [],
                    areas_mejora: [],
                    recomendaciones: [],
                    indicadores_clave: {},
                    alertas: []
                };
            }
            
            isAnalyzing = false;
            updateAnalysisButton();
            renderTabContent();
        }

        // Funci√≥n para actualizar el bot√≥n de an√°lisis
        function updateAnalysisButton() {
            const button = document.getElementById('analyze-button');
            if (button) {
                button.disabled = isAnalyzing;
                button.textContent = isAnalyzing ? 'Analizando...' : 'Analizar con IA';
                button.className = `px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors ${isAnalyzing ? 'opacity-50 cursor-not-allowed' : ''}`;
            }
        }

        // Componente para an√°lisis IA
        function createAIAnalysisPanel() {
            let analysisContent = '';
            
            if (aiAnalysis) {
                analysisContent = `
                    <div class="space-y-4">
                        <div class="bg-white p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-2">Resumen Ejecutivo</h4>
                            <p class="text-gray-700">${aiAnalysis.resumen_ejecutivo}</p>
                        </div>
                        
                        ${aiAnalysis.fortalezas && aiAnalysis.fortalezas.length > 0 ? `
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800 mb-2 flex items-center">
                                    ${createIcon('check-circle', 16, 'mr-2')}
                                    Fortalezas
                                </h4>
                                <ul class="list-disc list-inside text-green-700 space-y-1">
                                    ${aiAnalysis.fortalezas.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${aiAnalysis.areas_mejora && aiAnalysis.areas_mejora.length > 0 ? `
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                                    ${createIcon('alert-circle', 16, 'mr-2')}
                                    √Åreas de Mejora
                                </h4>
                                <ul class="list-disc list-inside text-yellow-700 space-y-1">
                                    ${aiAnalysis.areas_mejora.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${aiAnalysis.recomendaciones && aiAnalysis.recomendaciones.length > 0 ? `
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">Recomendaciones</h4>
                                <ul class="list-disc list-inside text-blue-700 space-y-1">
                                    ${aiAnalysis.recomendaciones.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-lg shadow-md">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            ${createIcon('brain', 24, 'mr-2 text-indigo-600')}
                            An√°lisis Inteligente
                        </h3>
                        <div class="flex space-x-2">
                            <button
                                id="analyze-button"
                                onclick="analyzeWithAI()"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors"
                            >
                                Analizar con IA
                            </button>
                            <button
                                onclick="exportToPDF()"
                                class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors flex items-center"
                            >
                                ${createIcon('download', 16, 'mr-1')}
                                Exportar PDF
                            </button>
                        </div>
                    </div>
                    ${analysisContent}
                </div>
            `;
        }

        // Funci√≥n para cambiar de pesta√±a
        function setActiveTab(tabId) {
            activeTab = tabId;
            renderTabs();
            renderTabContent();
            updateNavigationButtons();
        }

        // Funci√≥n para actualizar datos
        function updateData(field, value) {
            appData[field] = value;
            
            // Recalcular valores autom√°ticos cuando cambien campos clave
            if (['volumen', 'precio_leche', 'vacas', 'novillas', 'area', 'valor_hectarea'].includes(field)) {
                calculateAutomaticValues();
            }
            
            renderTabContent();
        }

        // Renderizar pesta√±as
        function renderTabs() {
            const tabNavigation = document.getElementById('tab-navigation');
            tabNavigation.innerHTML = tabs.map(tab => {
                const isCompleted = savedSections.has(tab.id);
                const completedIcon = isCompleted ? `${createIcon('check-circle', 14, 'mr-1 text-green-600')}` : '';
                
                return `
                    <button
                        onclick="setActiveTab('${tab.id}')"
                        class="flex items-center px-6 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap ${
                            activeTab === tab.id ? 'tab-active' : 'tab-inactive'
                        }"
                    >
                        ${completedIcon}
                        ${createIcon(tab.icon, 16, 'mr-2')}
                        ${tab.label}
                    </button>
                `;
            }).join('');
        }

        // Renderizar contenido de pesta√±as
        function renderTabContent() {
            const calculations = getCalculations();
            const tabContent = document.getElementById('tab-content');
            
            let content = '';

            if (activeTab === 'datos_generales') {
                content = `
                    <div class="space-y-6">
                        <!-- Informaci√≥n de la Finca -->
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                ${createIcon('building', 24, 'mr-2 text-green-600')}
                                Informaci√≥n de la Finca
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${createInputField('Nombre de la Finca', appData.nombre_finca, 'nombre_finca', 'text', 0, 'Nombre o raz√≥n social de la finca')}
                                ${createInputField('Propietario', appData.propietario, 'propietario', 'text', 0, 'Nombre del propietario o administrador')}
                                ${createInputField('Tel√©fono', appData.telefono, 'telefono', 'text', 0, 'N√∫mero de contacto')}
                                ${createInputField('Email', appData.email, 'email', 'email', 0, 'Correo electr√≥nico de contacto')}
                                ${createInputField('Ubicaci√≥n', appData.ubicacion, 'ubicacion', 'text', 0, 'Direcci√≥n o ubicaci√≥n espec√≠fica')}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
                            ${createKPICard('Vacas en Producci√≥n', appData.vacas, 'calculator', 'green', null, 'cabezas')}
                            ${createKPICard('√Årea Total', appData.area, 'pie-chart', 'blue', null, 'hect√°reas')}
                            ${createKPICard('Producci√≥n Anual', appData.volumen, 'trending-up', 'purple', null, 'litros')}
                            ${createKPICard('Precio Leche', appData.precio_leche, 'dollar-sign', 'yellow', null, '$/litro')}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Datos Productivos</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${createInputField('Vacas en Producci√≥n', appData.vacas, 'vacas', 'number', 0, 'N√∫mero de vacas actualmente en producci√≥n')}
                                    ${createInputField('√Årea de la Finca (ha)', appData.area, 'area', 'number', 0, '√Årea total de la finca en hect√°reas')}
                                    ${createInputField('Volumen Anual (L)', appData.volumen, 'volumen', 'number', 0, 'Producci√≥n total de leche en el a√±o')}
                                    ${createInputField('Precio Leche ($/L)', appData.precio_leche, 'precio_leche', 'number', 0, 'Precio promedio pagado por litro de leche')}
                                    ${createInputField('N√∫mero de Empleados', appData.empleados, 'empleados', 'number', 0, 'Total de empleados en la finca')}
                                    ${createInputField('N√∫mero de Novillas', appData.novillas, 'novillas', 'number', 0, 'N√∫mero de novillas en la finca')}
                                    ${createInputField('Valor por Hect√°rea ($)', appData.valor_hectarea, 'valor_hectarea', 'number', 0, 'Valor comercial por hect√°rea de tierra')}
                                </div>
                            </div>

                            <div class="space-y-4">
                                ${createSimpleChart('Indicadores de Productividad', [
                                    { label: 'Litros/Vaca/A√±o', value: Math.round(calculations.productividad_por_vaca) },
                                    { label: 'Litros/Hect√°rea', value: Math.round(calculations.productividad_por_hectarea) },
                                    { label: 'Litros/Empleado', value: Math.round(calculations.litros_por_empleado) },
                                    { label: 'Vacas/Hect√°rea', value: parseFloat((appData.vacas / appData.area).toFixed(1)) }
                                ])}
                                
                                ${createSimpleChart('Leche Equivalente', [
                                    { label: 'Leche Equiv. Total', value: Math.round(calculations.leche_equivalente_total) },
                                    { label: 'Leche Equiv./Vaca', value: Math.round(calculations.leche_equivalente_por_vaca) },
                                    { label: 'Leche Equiv./Hect√°rea', value: Math.round(calculations.leche_equivalente_por_hectarea) }
                                ])}
                                
                                <div class="bg-white p-4 rounded-lg shadow-md">
                                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Informaci√≥n Adicional</h4>
                                    <div class="space-y-2">
                                        ${createInputField('Regi√≥n', appData.region, 'region', 'text')}
                                        ${createInputField('Sistema de Producci√≥n', appData.sistema_produccion, 'sistema_produccion', 'text')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (activeTab === 'ingresos') {
                content = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-6">
                            ${createKPICard('Ingresos Totales', calculations.total_ingresos, 'trending-up', 'green')}
                            ${createKPICard('Venta de Leche', appData.venta_leche, 'dollar-sign', 'blue')}
                            ${createKPICard('Otros Ingresos', calculations.total_ingresos - appData.venta_leche, 'pie-chart', 'purple')}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Ingresos Operativos</h3>
                                <div class="space-y-4">
                                    ${createInputField('Venta de Leche ($/a√±o)', appData.venta_leche, 'venta_leche', 'number', 0, 'Calculado autom√°ticamente: Volumen √ó Precio', true)}
                                    ${createInputField('Venta de Animales ($/a√±o)', appData.venta_animales, 'venta_animales', 'number', 0, 'Ingresos por venta de animales')}
                                    ${createInputField('Venta de Esti√©rcol ($/a√±o)', appData.venta_estiercol, 'venta_estiercol', 'number', 0, 'Ingresos por venta de esti√©rcol')}
                                    ${createInputField('Otros Ingresos ($/a√±o)', appData.otros_ingresos, 'otros_ingresos', 'number', 0, 'Otros ingresos diversos')}
                                    ${createInputField('Cambio Stock Animales ($/a√±o)', appData.cambio_stock_animales, 'cambio_stock_animales', 'number', 0, 'Cambio en el valor del stock de animales')}
                                    ${createInputField('Cambio Stock Alimentos ($/a√±o)', appData.cambio_stock_alimentos, 'cambio_stock_alimentos', 'number', 0, 'Cambio en el valor del stock de alimentos')}
                                </div>
                            </div>

                            <div class="space-y-4">
                                ${createSimpleChart('Composici√≥n de Ingresos', [
                                    { label: 'Venta de Leche', value: appData.venta_leche },
                                    { label: 'Venta de Animales', value: appData.venta_animales },
                                    { label: 'Venta de Esti√©rcol', value: appData.venta_estiercol },
                                    { label: 'Cambio Stock Animales', value: appData.cambio_stock_animales },
                                    { label: 'Cambio Stock Alimentos', value: appData.cambio_stock_alimentos },
                                    { label: 'Otros Ingresos', value: appData.otros_ingresos }
                                ])}
                                
                                <div class="bg-white p-4 rounded-lg shadow-md">
                                    <h4 class="text-lg font-semibold mb-3 text-gray-800">An√°lisis de Ingresos</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Participaci√≥n Leche:</span>
                                            <span class="font-medium">${calculations.total_ingresos > 0 ? ((appData.venta_leche / calculations.total_ingresos) * 100).toFixed(1) : 0}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Leche Equiv. Total:</span>
                                            <span class="font-medium">${formatNumber(calculations.leche_equivalente_total.toFixed(0))} L</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Leche Equiv./Vaca:</span>
                                            <span class="font-medium">${formatNumber(calculations.leche_equivalente_por_vaca.toFixed(0))} L</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Ingreso por Vaca:</span>
                                            <span class="font-medium">${formatCurrency(appData.vacas > 0 ? calculations.total_ingresos / appData.vacas : 0)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Ingreso por Hect√°rea:</span>
                                            <span class="font-medium">${formatCurrency(appData.area > 0 ? calculations.total_ingresos / appData.area : 0)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Ingreso por Litro:</span>
                                            <span class="font-medium">${formatCurrency(appData.volumen > 0 ? calculations.total_ingresos / appData.volumen : 0)}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (activeTab === 'gastos') {
                content = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-6">
                            ${createKPICard('Gastos B√°sicos', calculations.gastos_basicos, 'dollar-sign', 'red')}
                            ${createKPICard('Gastos Adicionales', calculations.gastos_adicionales, 'trending-up', 'orange')}
                            ${createKPICard('Gastos Totales', calculations.total_gastos, 'calculator', 'purple')}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Gastos B√°sicos</h3>
                                <div class="space-y-4 scroll-container">
                                    ${createInputField('Mantenimiento Maquinaria', appData.mantenimiento_maquinas, 'mantenimiento_maquinas')}
                                    ${createInputField('Mantenimiento Instalaciones', appData.mantenimiento_instalaciones, 'mantenimiento_instalaciones')}
                                    ${createInputField('Alquiler de M√°quinas', appData.alquiler_maquinas, 'alquiler_maquinas')}
                                    ${createInputField('Energ√≠a y Combustibles', appData.energia, 'energia')}
                                    ${createInputField('Alimentos Comprados', appData.alimentos_comprados, 'alimentos_comprados')}
                                    ${createInputField('Fertilizantes', appData.correctivos_fertilizantes, 'correctivos_fertilizantes')}
                                    ${createInputField('Productos Qu√≠micos', appData.productos_quimicos, 'productos_quimicos')}
                                    ${createInputField('Semillas', appData.semillas, 'semillas')}
                                    ${createInputField('Reproducci√≥n', appData.reproduccion, 'reproduccion')}
                                    ${createInputField('Sanidad', appData.salud, 'salud')}
                                    ${createInputField('Consumibles', appData.consumibles, 'consumibles')}
                                    ${createInputField('BST', appData.bst, 'bst')}
                                    ${createInputField('Impuestos', appData.impuestos, 'impuestos')}
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-white p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">Gastos Adicionales</h3>
                                    <div class="space-y-4">
                                        ${createInputField('Mano de Obra Fija', appData.mano_obra_fija, 'mano_obra_fija')}
                                        ${createInputField('Mano de Obra Temporal', appData.mano_obra_temporal, 'mano_obra_temporal')}
                                        ${createInputField('Administraci√≥n', appData.administracion, 'administracion')}
                                        ${createInputField('Intereses Pr√©stamos', appData.intereses_prestamos, 'intereses_prestamos')}
                                        ${createInputField('Depreciaci√≥n Maquinaria', appData.depreciacion_maquinaria, 'depreciacion_maquinaria')}
                                        ${createInputField('Depreciaci√≥n Instalaciones', appData.depreciacion_instalaciones, 'depreciacion_instalaciones')}
                                    </div>
                                </div>

                                ${createSimpleChart('Principales Componentes de Gastos', [
                                    { label: 'Alimentos', value: appData.alimentos_comprados },
                                    { label: 'Mano de Obra Total', value: appData.mano_obra_fija + appData.mano_obra_temporal },
                                    { label: 'Administraci√≥n', value: appData.administracion },
                                    { label: 'Energ√≠a', value: appData.energia },
                                    { label: 'Mantenimiento', value: appData.mantenimiento_maquinas + appData.mantenimiento_instalaciones },
                                    { label: 'Sanidad', value: appData.salud }
                                ])}
                                
                                <div class="bg-white p-4 rounded-lg shadow-md">
                                    <h4 class="text-lg font-semibold mb-3 text-gray-800">An√°lisis de Costos</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Costo por Litro:</span>
                                            <span class="font-medium">${formatCurrency(calculations.costo_produccion_litro)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Costo por Vaca:</span>
                                            <span class="font-medium">${formatCurrency(appData.vacas > 0 ? calculations.total_gastos / appData.vacas : 0)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Eficiencia Mano de Obra:</span>
                                            <span class="font-medium">${formatNumber(calculations.litros_por_empleado)} L/empleado</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (activeTab === 'inversiones') {
                content = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
                            ${createKPICard('Inversi√≥n Total', calculations.total_inversiones, 'pie-chart', 'blue')}
                            ${createKPICard('Tierra', appData.inversiones_tierra, 'trending-up', 'green')}
                            ${createKPICard('Animales', appData.inversiones_animales, 'calculator', 'purple')}
                            ${createKPICard('Infraestructura', appData.inversiones_instalaciones + appData.inversiones_maquinaria, 'dollar-sign', 'orange')}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Inversiones por Categor√≠a</h3>
                                <div class="space-y-4">
                                    ${createInputField('Instalaciones ($)', appData.inversiones_instalaciones, 'inversiones_instalaciones', 'number', 0, 'Valor de instalaciones y construcciones')}
                                    ${createInputField('Maquinaria y Equipo ($)', appData.inversiones_maquinaria, 'inversiones_maquinaria', 'number', 0, 'Valor de maquinaria y equipos')}
                                    ${createInputField('Animales ($)', appData.inversiones_animales, 'inversiones_animales', 'number', 0, 'Calculado autom√°ticamente seg√∫n n√∫mero de animales', true)}
                                    ${createInputField('Tierra ($)', appData.inversiones_tierra, 'inversiones_tierra', 'number', 0, 'Calculado autom√°ticamente: √Årea √ó Valor/ha', true)}
                                </div>
                            </div>

                            <div class="space-y-4">
                                ${createSimpleChart('Distribuci√≥n de Inversiones', [
                                    { label: 'Tierra', value: appData.inversiones_tierra },
                                    { label: 'Animales', value: appData.inversiones_animales },
                                    { label: 'Instalaciones', value: appData.inversiones_instalaciones },
                                    { label: 'Maquinaria', value: appData.inversiones_maquinaria }
                                ])}
                                
                                <div class="bg-white p-4 rounded-lg shadow-md">
                                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Indicadores de Inversi√≥n</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Inversi√≥n por Vaca:</span>
                                            <span class="font-medium">${formatCurrency(appData.vacas > 0 ? calculations.total_inversiones / appData.vacas : 0)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Inversi√≥n por Hect√°rea:</span>
                                            <span class="font-medium">${formatCurrency(appData.area > 0 ? calculations.total_inversiones / appData.area : 0)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>% Tierra:</span>
                                            <span class="font-medium">${calculations.total_inversiones > 0 ? ((appData.inversiones_tierra / calculations.total_inversiones) * 100).toFixed(1) : 0}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>% Animales:</span>
                                            <span class="font-medium">${calculations.total_inversiones > 0 ? ((appData.inversiones_animales / calculations.total_inversiones) * 100).toFixed(1) : 0}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>% Infraestructura:</span>
                                            <span class="font-medium">${calculations.total_inversiones > 0 ? (((appData.inversiones_instalaciones + appData.inversiones_maquinaria) / calculations.total_inversiones) * 100).toFixed(1) : 0}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (activeTab === 'resultados') {
                content = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4 mb-6">
                            ${createKPICard('Lucro Anual', calculations.lucro, 'trending-up', calculations.lucro > 0 ? 'green' : 'red')}
                            ${createKPICard('Retorno Capital', `${calculations.retorno_capital.toFixed(2)}%`, 'pie-chart', calculations.retorno_capital > 0 ? 'green' : 'red')}
                            ${createKPICard('Margen por Litro', calculations.margen_por_litro, 'calculator', calculations.margen_por_litro > 0 ? 'green' : 'red')}
                            ${createKPICard('Productividad', `${calculations.productividad_por_vaca.toFixed(0)} L/vaca`, 'bar-chart-3', 'blue')}
                            ${createKPICard('Leche Equiv. Total', `${formatNumber(calculations.leche_equivalente_total.toFixed(0))} L`, 'droplets', 'purple')}
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Resultados Financieros</h3>
                                <div class="space-y-4">
                                    <div class="border-b pb-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Ingresos Totales:</span>
                                            <span class="text-green-600 font-bold">${formatCurrency(calculations.total_ingresos)}</span>
                                        </div>
                                    </div>
                                    <div class="border-b pb-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Gastos B√°sicos:</span>
                                            <span class="text-red-600">${formatCurrency(calculations.gastos_basicos)}</span>
                                        </div>
                                    </div>
                                    <div class="border-b pb-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Gastos Adicionales:</span>
                                            <span class="text-red-600">${formatCurrency(calculations.gastos_adicionales)}</span>
                                        </div>
                                    </div>
                                    <div class="border-b pb-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Gastos Totales:</span>
                                            <span class="text-red-600 font-bold">${formatCurrency(calculations.total_gastos)}</span>
                                        </div>
                                    </div>
                                    <div class="pt-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-bold text-lg">Lucro:</span>
                                            <span class="font-bold text-lg ${calculations.lucro > 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${formatCurrency(calculations.lucro)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                ${createSimpleChart('An√°lisis de Rentabilidad', [
                                    { label: 'Ingresos', value: calculations.total_ingresos },
                                    { label: 'Gastos B√°sicos', value: calculations.gastos_basicos },
                                    { label: 'Gastos Adicionales', value: calculations.gastos_adicionales },
                                    { label: 'Lucro', value: Math.abs(calculations.lucro) }
                                ])}
                                
                                <div class="bg-white p-4 rounded-lg shadow-md">
                                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Indicadores Clave</h4>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Margen Bruto:</span>
                                            <span class="font-medium">${calculations.total_ingresos > 0 ? ((calculations.lucro / calculations.total_ingresos) * 100).toFixed(2) : 0}%</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Punto de Equilibrio:</span>
                                            <span class="font-medium">${formatCurrency(calculations.costo_produccion_litro)}/L</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Eficiencia Productiva:</span>
                                            <span class="font-medium">${calculations.productividad_por_hectarea.toFixed(0)} L/ha</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Litros por Empleado:</span>
                                            <span class="font-medium">${formatNumber(calculations.litros_por_empleado)}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>ROI Anual:</span>
                                            <span class="font-medium ${calculations.retorno_capital > 0 ? 'text-green-600' : 'text-red-600'}">${calculations.retorno_capital.toFixed(2)}%</span>
                                        </div>
                                        <div class="flex justify-between border-t pt-2">
                                            <span><strong>Leche Equivalente:</strong></span>
                                            <span class="font-medium text-purple-600">${formatNumber(calculations.leche_equivalente_total.toFixed(0))} L</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Leche Equiv./Vaca:</span>
                                            <span class="font-medium">${formatNumber(calculations.leche_equivalente_por_vaca.toFixed(0))} L</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Leche Equiv./Hect√°rea:</span>
                                            <span class="font-medium">${formatNumber(calculations.leche_equivalente_por_hectarea.toFixed(0))} L</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (activeTab === 'analisis') {
                content = `
                    <div class="space-y-6">
                        ${createAIAnalysisPanel()}
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Benchmarking Regional</h3>
                                <div class="space-y-4">
                                    <div class="border-l-4 border-blue-500 pl-4">
                                        <h4 class="font-semibold text-gray-800">Productividad vs Regi√≥n</h4>
                                        <p class="text-sm text-gray-600">
                                            Su finca: ${calculations.productividad_por_vaca.toFixed(0)} L/vaca/a√±o
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            Promedio regional: 6,500 L/vaca/a√±o
                                        </p>
                                        <div class="text-sm font-medium ${calculations.productividad_por_vaca > 6500 ? 'text-green-600' : 'text-orange-600'}">
                                            ${calculations.productividad_por_vaca > 6500 ? '‚úì Por encima del promedio' : '‚ö† Por debajo del promedio'}
                                        </div>
                                    </div>
                                    
                                    <div class="border-l-4 border-green-500 pl-4">
                                        <h4 class="font-semibold text-gray-800">Rentabilidad vs Sector</h4>
                                        <p class="text-sm text-gray-600">
                                            Su ROI: ${calculations.retorno_capital.toFixed(2)}%
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            Promedio sector: 8-12%
                                        </p>
                                        <div class="text-sm font-medium ${calculations.retorno_capital > 8 ? 'text-green-600' : 'text-orange-600'}">
                                            ${calculations.retorno_capital > 8 ? '‚úì Rentabilidad competitiva' : '‚ö† Oportunidad de mejora'}
                                        </div>
                                    </div>

                                    <div class="border-l-4 border-purple-500 pl-4">
                                        <h4 class="font-semibold text-gray-800">Eficiencia de Costos</h4>
                                        <p class="text-sm text-gray-600">
                                            Su costo: ${formatCurrency(calculations.costo_produccion_litro)}/litro
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            Promedio sector: $1,800-2,200/litro
                                        </p>
                                        <div class="text-sm font-medium ${calculations.costo_produccion_litro < 2000 ? 'text-green-600' : 'text-orange-600'}">
                                            ${calculations.costo_produccion_litro < 2000 ? '‚úì Costos competitivos' : '‚ö† Optimizar costos'}
                                        </div>
                                    </div>

                                    <div class="border-l-4 border-indigo-500 pl-4">
                                        <h4 class="font-semibold text-gray-800">Leche Equivalente</h4>
                                        <p class="text-sm text-gray-600">
                                            Total: ${formatNumber(calculations.leche_equivalente_total.toFixed(0))} L
                                        </p>
                                        <p class="text-sm text-gray-600">
                                            Por vaca: ${formatNumber(calculations.leche_equivalente_por_vaca.toFixed(0))} L
                                        </p>
                                        <div class="text-sm font-medium text-indigo-600">
                                            üìä Indicador clave de eficiencia total
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Simulador de Escenarios</h3>
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-blue-800 mb-2">Escenario Optimista (+10% Precio)</h4>
                                        <div class="text-sm space-y-1">
                                            <div class="flex justify-between">
                                                <span>Nuevo Precio:</span>
                                                <span>${formatCurrency(appData.precio_leche * 1.1)}/L</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Lucro Proyectado:</span>
                                                <span class="font-bold text-green-600">
                                                    ${formatCurrency(calculations.lucro + (appData.volumen * appData.precio_leche * 0.1))}
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>ROI Proyectado:</span>
                                                <span class="font-bold text-green-600">
                                                    ${calculations.total_inversiones > 0 ? (((calculations.lucro + (appData.volumen * appData.precio_leche * 0.1)) / calculations.total_inversiones) * 100).toFixed(2) : 0}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-red-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-red-800 mb-2">Escenario Pesimista (-10% Precio)</h4>
                                        <div class="text-sm space-y-1">
                                            <div class="flex justify-between">
                                                <span>Nuevo Precio:</span>
                                                <span>${formatCurrency(appData.precio_leche * 0.9)}/L</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Lucro Proyectado:</span>
                                                <span class="font-bold text-red-600">
                                                    ${formatCurrency(calculations.lucro - (appData.volumen * appData.precio_leche * 0.1))}
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>ROI Proyectado:</span>
                                                <span class="font-bold text-red-600">
                                                    ${calculations.total_inversiones > 0 ? (((calculations.lucro - (appData.volumen * appData.precio_leche * 0.1)) / calculations.total_inversiones) * 100).toFixed(2) : 0}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <h4 class="font-semibold text-green-800 mb-2">Mejora Productividad (+15%)</h4>
                                        <div class="text-sm space-y-1">
                                            <div class="flex justify-between">
                                                <span>Nueva Producci√≥n:</span>
                                                <span>${formatNumber(appData.volumen * 1.15)} L/a√±o</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Lucro Proyectado:</span>
                                                <span class="font-bold text-green-600">
                                                    ${formatCurrency(calculations.lucro + (appData.volumen * 0.15 * appData.precio_leche))}
                                                </span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Nueva Leche Equiv.:</span>
                                                <span class="font-bold text-purple-600">
                                                    ${formatNumber((calculations.leche_equivalente_total * 1.15).toFixed(0))} L
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            tabContent.innerHTML = content;
            
            // Inicializar iconos de Lucide despu√©s de actualizar el contenido
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Calcular valores autom√°ticos al cargar
            calculateAutomaticValues();
            
            renderTabs();
            renderTabContent();
            updateNavigationButtons();
            updateProgress();
            
            // Inicializar iconos de Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>
